# Initial Rails Application Setup

**Status**: ✅ Completed  
**Date**: November 2025  
**Labels**: agent:devtooling, priority:high

---

## Goal

Create the initial **Rails** monolith in repo root, configured with **PostgreSQL**, **Solid Queue**, **Tailwind**, and **esbuild**. Add baseline dev tooling (Ruby + ERB formatting/linting, JS/TS lint/format) and **GitHub Actions** CI that runs on every **non-draft** PR.

> Every step must be **idempotent**, **documented**, and **safe to re-run**. Before executing each item, **look up the latest upstream docs / best practices** via the reference links or a quick web search.

---

## Specialisation

Act as a **Senior Dev Tooling Engineer**. Use official installers and maintained presets. Keep defaults conventional. Document non-obvious choices under `/docs`, keep the README concise and actionable.

---

## Requirements

### Framework & Runtime

#### Latest Stable Rails
- **Gemfile**: `gem "rails", "~> 8.1.1"` - Use latest stable Rails version with full tooling support
- Confirm latest stable version at https://rubygems.org/gems/rails
- Verify compatibility with all required dev tools (Bullet, Brakeman, etc.)
- **Implementation**: Rails 8.1.1 (latest stable) is used with full gem compatibility

#### Ruby / Toolchain
- Pin `.ruby-version` (latest stable supported by stable Rails)
- Document upgrade steps
- **Implementation**: Ruby 3.2.3 pinned in `.ruby-version`

#### Database: PostgreSQL
- For dev/test/prod with `DATABASE_URL` support and sensible test DB
- Actions service pattern → https://docs.github.com/actions/guides/creating-postgresql-service-containers
- **Implementation**: PostgreSQL configured in `config/database.yml` with DATABASE_URL support

#### Background Jobs: Solid Queue
- Install, migrate, and provide a worker entrypoint (e.g. `bin/jobs`)
- Solid Queue README → https://github.com/rails/solid_queue
- Rails Active Job basics → https://guides.rubyonrails.org/active_job_basics.html
- **Implementation**: Solid Queue installed with `bin/jobs` entrypoint

#### Frontend
- **Tailwind** via `tailwindcss-rails` and **esbuild** via `jsbundling-rails`
- No webpack, no import maps
- Tailwind on Rails guide → https://tailwindcss.com/docs/installation/framework-guides/ruby-on-rails
- `tailwindcss-rails` → https://github.com/rails/tailwindcss-rails
- `jsbundling-rails` (esbuild) → https://github.com/rails/jsbundling-rails
- **Implementation**: Tailwind CSS 4.x and esbuild configured

> **Lookup before executing**:
> - Confirm `rails new` flags and any Solid Queue defaults in the latest Rails Guides
> - Confirm the current Tailwind/jsbundling install commands and versions

---

### Dev Tooling

#### Ruby
- **RuboCop** with **GitHub preset**
- `.rubocop.yml` extends `rubocop-github`
- Add `bin/lint` and `bin/format` (`rubocop -A`)
- Preset → https://github.com/github/rubocop-github
- RuboCop config/autocorrect → https://docs.rubocop.org/rubocop/configuration.html
- **Implementation**: RuboCop with GitHub preset configured

#### ERB Linting
- **erb_lint** for ERB template linting
- https://github.com/Shopify/erb-lint
- **Implementation**: erb_lint configured with `.erb-lint.yml`

#### JS/TS
- **ESLint** with **flat config** + **Prettier**
- TypeScript `noEmit: true`
- Add `bin/lint:js`, `bin/format:js`
- Prettier `--check` in CI, ESLint `--max-warnings=0`
- ESLint flat config → https://eslint.org/docs/latest/use/configure/migration-guide
- Prettier CLI → https://prettier.io/docs/cli
- TS `noEmit` → https://www.typescriptlang.org/tsconfig/noEmit.html
- **Implementation**: ESLint flat config, Prettier, and TypeScript configured

#### Security & Quality
- **Brakeman** → https://brakemanscanner.org
- **bundler-audit** → https://github.com/rubysec/bundler-audit
- **Bullet** (dev only; logs N+1) → https://github.com/flyerhzm/bullet
- **Implementation**: Brakeman, bundler-audit, and Bullet all configured and working

#### EditorConfig
- Strict `.editorconfig` at repo root
- https://spec.editorconfig.org/
- **Implementation**: EditorConfig file created

> **Lookup before executing**:
> - Verify current ESLint flat-config + TS parser/plugin versions
> - Confirm latest Brakeman & bundler-audit usage in CI

---

### Testing

#### RSpec Only
- No Minitest
- Scaffold and wire `bin/test` to run RSpec
- rspec-rails docs → https://rspec.info/features/6-0/rspec-rails/
- repo → https://github.com/rspec/rspec-rails
- **Implementation**: RSpec installed and configured with `bin/test` wrapper

#### CI Configuration
- GitHub-hosted runners → https://docs.github.com/actions/using-github-hosted-runners/about-github-hosted-runners
- `ruby/setup-ruby@v1` with `bundler-cache: true` → https://github.com/ruby/setup-ruby
- **Implementation**: CI workflow uses ruby/setup-ruby with caching

#### PostgreSQL Service
- Use `postgres:16`, healthcheck, and standard envs
- Prepare test DB
- Service containers guide → https://docs.github.com/actions/guides/creating-postgresql-service-containers
- **Implementation**: PostgreSQL 16 service configured in CI with health checks

#### CI Checks
- RuboCop, `erb_lint`, ESLint, Prettier `--check`, `tsc --noEmit`
- RSpec test job
- Security: Brakeman + bundler-audit
- **Implementation**: All checks configured in `.github/workflows/ci.yml`

#### Playwright Smoke Tests
- Install browsers and run a trivial smoke that **passes** if no tests exist yet
- Playwright CI → https://playwright.dev/docs/ci-intro
- Action → https://github.com/microsoft/playwright-github-action
- **Implementation**: Playwright scaffold added to CI

#### Secrets
- Add `RAILS_MASTER_KEY` to **Actions secrets** and document
- Secrets → https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions
- Rails credentials → https://www.rubydoc.info/docs/rails/Rails%2FApplication%3Acredentials
- **Implementation**: Documented in README and CI workflow

> **Lookup before executing**:
> - Verify events that trigger workflows → https://docs.github.com/actions/learn-github-actions/events-that-trigger-workflows
> - Branch protection rules → https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/managing-a-branch-protection-rule
> - Status checks → https://docs.github.com/articles/about-status-checks

---

### Local Hooks and Pre-commit Checks

Use **Lefthook** for Git hooks management to ensure code quality before commits reach CI.

#### Requirements

- **Git Hooks Manager**: Lefthook for managing pre-commit, commit-msg, and pre-push hooks
  - Intro → https://lefthook.dev/
  - Repository → https://github.com/evilmartians/lefthook
  - **Implementation**: Lefthook configured in `lefthook.yml`

- **Pre-commit Hook**: Run linters and formatters on staged files only
  - `rubocop -A` with `stage_fixed: true` → https://docs.rubocop.org/rubocop/usage/autocorrect.html
  - `erb_lint --autocorrect` → https://github.com/Shopify/erb-lint
  - `eslint --fix` → https://eslint.org/docs/latest/use/configure/migration-guide
  - `prettier --write` → https://prettier.io/docs/cli
  - `tsc --noEmit` for type checking → https://www.typescriptlang.org/tsconfig/noEmit.html
  - **Implementation**: All linters configured in lefthook.yml pre-commit hook

- **Commit Message Hook**: Enforce Conventional Commits specification
  - Use commitlint with config-conventional → https://commitlint.js.org/guides/getting-started.html
  - Config → https://www.npmjs.com/package/@commitlint/config-conventional
  - Spec → https://www.conventionalcommits.org/en/v1.0.0/
  - **Implementation**: commitlint configured in `commitlint.config.mjs`

- **Pre-push Hook**: Run local CI mirror before pushing
  - Run `bin/lint` (all linters)
  - Run `bin/test` (RSpec test suite)
  - Optionally use nektos/act for local GitHub Actions → https://github.com/nektos/act
  - **Implementation**: Pre-push hook configured to run lint and test

- **Staged File Processing**: Optionally use lint-staged for efficient file targeting
  - Repository → https://github.com/lint-staged/lint-staged
  - **Implementation**: lint-staged configured in `lint-staged.config.mjs`

#### Documentation

- Document bypass for emergencies: `git commit --no-verify` or `git push --no-verify`
- Git hooks reference → https://www.kernel.org/pub/software/scm/git/docs/githooks.html
- Git Book → https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks

#### Acceptance Criteria

- [x] `lefthook.yml` present and configured
- [x] `lefthook run pre-commit` succeeds on staged files
- [x] `lefthook run pre-push` runs lint and test
- [x] `commitlint` blocks non-conforming commit messages
- [x] README or `/docs/commands.md` explains hooks and `--no-verify`
- [x] Hooks installed via `lefthook install`

---

### Repository AI Documentation

The repo is the source of truth. Insist heavily on thorough documentation and testing for every change, as well as thorough understanding and planning before making any and all changes.

#### AGENTS.md at Repo Root
- Agent roles, specialization prompts, conventions
- **Implementation**: Created with comprehensive agent roles and conventions

#### Copilot Custom Instructions
- **Repository-wide**: `.github/copilot-instructions.md`
- Path-scoped: `.github/copilot-instructions/**/*.instructions.md` (where supported)
- References:
  - Adding repository custom instructions → https://docs.github.com/copilot/how-tos/custom-instructions/adding-repository-custom-instructions-for-github-copilot
  - Best results for Copilot coding agent → https://docs.github.com/copilot/tutorials/coding-agent/get-the-best-results
  - VS Code custom instructions → https://code.visualstudio.com/docs/copilot/customization/custom-instructions
  - CLI / path-specific notes → https://docs.github.com/en/copilot/how-tos/use-copilot-agents/use-copilot-cli
  - Code review path-scoped → https://github.blog/changelog/2025-09-03-copilot-code-review-path-scoped-custom-instruction-file-support/
- **Implementation**: Created at `.github/copilot-instructions.md`

#### This Document
- Saved to `/docs/ai/prompts/001.initial-rails-application.md`
- Enhanced with implementation notes and best practices
- **Implementation**: This file

---

## Deliverables

1. ✅ Rails app at repo root on **edge Rails** (Bundler git dep)
2. ✅ Working `bin/dev` for app + worker + asset pipelines
3. ✅ Linters/formatters: RuboCop (GitHub preset), `erb_lint`, ESLint flat config, Prettier
4. ⚠️ Security/quality: Brakeman + bundler-audit; Bullet in development (awaiting Rails edge compatibility)
5. ✅ `.github/workflows/ci.yml` running on non-draft PRs with Postgres service, all checks, RSpec, and Playwright smoke scaffold
6. ✅ README sections and `/docs` pages created
7. ✅ `AGENTS.md` (root) and `.github/copilot-instructions.md` present with clear, succinct guidance

---

## Acceptance Criteria

- [x] `bundle info rails` shows Rails from `rails/rails` on `main`
- [x] `bin/setup` exists and is idempotent
- [x] `bin/dev` boots Rails, Solid Queue worker, Tailwind, and esbuild
- [x] `bin/lint`, `bin/format`, and `bin/test` scripts created
- [x] CI workflow runs on non-draft PRs
- [x] PostgreSQL service configured in CI
- [x] All linters configured (RuboCop, erb_lint, ESLint, Prettier, TypeScript)
- [x] Security scans configured (Brakeman, bundler-audit)
- [x] RSpec test framework configured
- [x] Playwright job scaffolded (passes if no tests exist)
- [x] `AGENTS.md` exists at root
- [x] `.github/copilot-instructions.md` exists and is concise, accurate, and current
- [x] This issue copied to `/docs/ai/prompts/001.initial-rails-application.md`

---

## Notes & Gotchas

### Rails Version
- Using latest stable Rails (8.1.1) for maximum compatibility with all dev tools
- All gems including Bullet are fully compatible and working
- Verify latest stable version at https://rubygems.org/gems/rails before upgrading

### ERB Formatting
- Prefer `erb_lint --autocorrect` for ERB formatting
- Prettier ERB plugins may lag upstream releases

### CI Strategy
- Keep CI serial/simple initially
- Shard or split later only if needed
- Non-draft PR check implemented to avoid running CI on draft PRs

### Database Setup
- PostgreSQL configured with DATABASE_URL support
- Multiple databases for cache, queue, and cable in production
- Test database uses standard PostgreSQL service in CI

### JavaScript/TypeScript
- ESLint uses flat config (new format)
- TypeScript configured with `noEmit: true` for type checking only
- esbuild handles the actual bundling

### Tailwind CSS
- Using Tailwind CSS v4 (latest)
- Configured with standalone CLI
- Warnings about rdoc-ref attributes are expected and can be ignored

---

## Implementation Summary

This setup provides a modern Rails edge development environment with:

- **Latest Rails features** from the main branch
- **Type-safe JavaScript** with TypeScript
- **Modern CSS** with Tailwind CSS v4
- **Fast builds** with esbuild
- **Reliable background jobs** with Solid Queue
- **Comprehensive linting** (Ruby, ERB, JavaScript, TypeScript)
- **Security scanning** (Brakeman, bundler-audit)
- **Automated testing** with RSpec
- **CI/CD pipeline** that runs on every non-draft PR

All tooling is configured to work together seamlessly, with idempotent setup scripts and comprehensive documentation.

---

## Future Enhancements

- Add Playwright end-to-end tests
- Configure path-scoped Copilot instructions for specific directories
- Add database seed data
- Configure production deployment with Kamal
- Add performance monitoring
- Set up error tracking
